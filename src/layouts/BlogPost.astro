---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";

import GoogleTag from "../components/GoogleTag.astro";

type Props = CollectionEntry<"blog">["data"];

// Destructure incoming props so template references (title, description, etc.) are defined
const { title, description, pubDate, heroImage, tags, updatedDate }: Props =
  Astro.props;

const readingTime = 5; // Default to 5 minutes for now
---

<html lang="en">
  <head>
    <BaseHead title={title} description={description} />
    <GoogleTag />
    <style>
      main {
        width: calc(100% - 2em);
        max-width: 100%;
        margin: 0 auto;
        background: rgb(var(--gray-gradient));
        min-height: 100vh;
      }
      .hero-image {
        width: 100%;
        position: relative;
        overflow: hidden;
      }
      .hero-image img {
        display: block;
        margin: 0 auto;
        border-radius: 8px;
        box-shadow: var(--box-shadow);
      }
      .back-link {
        max-width: 1152px;
        margin: 0 auto;
        padding: 0 1rem;
      }
      .back-link a {
        display: inline-flex;
        align-items: center;
        font-size: 0.9rem;
        color: #374151;
        text-decoration: none;
        transition: color 0.2s;
      }
      .back-link a:hover {
        color: #142934;
      }
      .dark .back-link a {
        color: #9ca3af;
      }
      .dark .back-link a:hover {
        color: #f3f4f6;
      }
      .article-container {
        max-width: 1152px;
        margin: 0 auto;
        padding: 2rem 1rem;
      }
      .article-header {
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
      }
      .dark .article-header {
        background: #1f2937;
        border-color: #374151;
      }
      .article-title {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.2;
        margin-bottom: 1rem;
        color: rgb(var(--gray-dark));
      }
      .article-meta {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
        color: #6b7280;
        font-size: 0.9rem;
      }
      .dark .article-meta {
        color: #9ca3af;
      }
      .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .tags {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }
      .tag {
        background: #f1f5f9;
        color: #475569;
        border: 1px solid #e2e8f0;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s ease;
      }
      .tag:hover {
        background: #e2e8f0;
        transform: translateY(-1px);
      }
      .dark .tag {
        background: #374151;
        color: #d1d5db;
        border-color: #4b5563;
      }
      .dark .tag:hover {
        background: #4b5563;
      }
      .article-content {
        background: white;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        padding: 2rem;
        line-height: 1.7;
      }
      .dark .article-content {
        background: #1f2937;
        border-color: #374151;
      }
      .last-updated-on {
        font-style: italic;
        color: #6b7280;
        margin-top: 0.5rem;
        font-size: 0.85rem;
      }
      .dark .last-updated-on {
        color: #9ca3af;
      }
      @media (max-width: 768px) {
        .article-title {
          font-size: 1.75rem;
        }
        .article-header,
        .article-content {
          padding: 1.5rem;
        }
        .article-meta {
          flex-direction: column;
          gap: 0.5rem;
        }
      }
    </style>
  </head>
  <body>
    <Header />
    <main class="dark:bg-gray-900 transition-colors duration-300">
      <article>
        {
          heroImage && (
            <div class="hero-image-container mx-auto w-full max-w-[1020px] h-[500px] mb-8 overflow-hidden rounded-lg shadow-md relative">
              <img
                id="hero-image"
                src={heroImage}
                alt={title}
                class="absolute inset-0 w-full h-[130%] object-cover object-center transition-transform duration-75 ease-out"
              />
            </div>
          )
        }
        <div class="back-link">
          <a href="/blog">‚Üê Back to blog</a>
        </div>

        <div class="article-container">
          <header class="article-header dark:bg-gray-800">
            <h1 class="article-title dark:text-gray-100">{title}</h1>

            <div class="article-meta">
              <div class="meta-item">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"
                  ></path>
                </svg>
                <FormattedDate date={pubDate} />
              </div>

              <div class="meta-item">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                  ></path>
                </svg>
                <span>{readingTime} min read</span>
              </div>
            </div>

            {
              tags && tags.length > 0 && (
                <div class="tags">
                  {tags.map((tag: string) => (
                    <span class="tag">#{tag}</span>
                  ))}
                </div>
              )
            }

            {
              updatedDate && (
                <div class="last-updated-on">
                  Last updated on <FormattedDate date={updatedDate} />
                </div>
              )
            }
          </header>

          <div class="article-content dark:bg-gray-800">
            <div class="markdown-body">
              <slot />
            </div>
          </div>
        </div>
      </article>
    </main>
    <Footer />

    <script>
      // Parallax effect for hero image
      (function () {
        const heroImageEl = document.getElementById("hero-image");
        if (!heroImageEl) return; // Nothing to do

        function updateParallax() {
          const scrolled = window.pageYOffset;
          const imageContainer = heroImageEl.parentElement;
          if (!imageContainer) return;
          const containerRect = imageContainer.getBoundingClientRect();
          const containerTop = containerRect.top + scrolled;
          const containerHeight = containerRect.height;
          if (
            scrolled + window.innerHeight > containerTop &&
            scrolled < containerTop + containerHeight
          ) {
            const parallaxSpeed = 0.3;
            const yPos = -(scrolled - containerTop) * parallaxSpeed;
            heroImageEl!.style.transform = `translateY(${yPos}px)`;
          }
        }
        let ticking = false;
        function requestTick() {
          if (!ticking) {
            requestAnimationFrame(updateParallax);
            ticking = true;
          }
        }
        function onScroll() {
          requestTick();
          ticking = false;
        }
        updateParallax();
        window.addEventListener("scroll", onScroll, { passive: true });
        window.addEventListener("beforeunload", () => {
          window.removeEventListener("scroll", onScroll);
        });
      })();
    </script>
  </body>
</html>
